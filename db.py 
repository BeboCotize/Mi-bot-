import psycopg2
import os

DB_URL = os.getenv("DATABASE_URL")

def get_conn():
    return psycopg2.connect(DB_URL, sslmode="require")

def init_db():
    conn = get_conn()
    cur = conn.cursor()
    cur.execute("""
        CREATE TABLE IF NOT EXISTS bans (
            user_id BIGINT PRIMARY KEY,
            until TIMESTAMP
        )
    """)
    conn.commit()
    cur.close()
    conn.close()

def ban_user(user_id, until):
    conn = get_conn()
    cur = conn.cursor()
    cur.execute("INSERT INTO bans (user_id, until) VALUES (%s, %s) ON CONFLICT (user_id) DO UPDATE SET until = EXCLUDED.until", (user_id, until))
    conn.commit()
    cur.close()
    conn.close()

def unban_user(user_id):
    conn = get_conn()
    cur = conn.cursor()
    cur.execute("DELETE FROM bans WHERE user_id = %s", (user_id,))
    conn.commit()
    cur.close()
    conn.close()

def is_banned(user_id):
    conn = get_conn()
    cur = conn.cursor()
    cur.execute("SELECT 1 FROM bans WHERE user_id = %s", (user_id,))
    res = cur.fetchone()
    cur.close()
    conn.close()
    return res is not None